<app-header titleLn1="PDR" titleLn2="SME Approval"></app-header>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="displayProgressSpinner">
  <div class="spinner-container">
    <mat-spinner diameter="48" color="primary"></mat-spinner>
    <p class="loading-text">Processing...</p>
  </div>
</div>

<div class="page-container">
  <mat-card class="approval-card" [@fadeInUp] *ngIf="loaded || recordNotFound">

    <!-- Compact Status Bar -->
    <div class="status-bar" *ngIf="loaded && !recordNotFound"
         [class.status-pending]="status.toLowerCase().includes('pending')"
         [class.status-approved]="status.toLowerCase().includes('approved')"
         [class.status-declined]="status.toLowerCase().includes('declined')">
      <div class="status-left">
        <mat-icon class="status-icon">
          {{ status.toLowerCase().includes('pending') ? 'hourglass_empty' :
             status.toLowerCase().includes('approved') ? 'check_circle' : 'cancel' }}
        </mat-icon>
        <div class="status-text">
          <span class="status-label">
            {{ status.toLowerCase().includes('pending') ? 'Pending Approval' :
               status.toLowerCase().includes('approved') ? 'Approved' : 'Declined' }}
          </span>
          <span class="case-num">Case: {{ record?.caseNum }}</span>
        </div>
      </div>
      <div class="status-right" *ngIf="!status.toLowerCase().includes('pending')">
        <span class="status-meta">{{ statusDate | date:'mediumDate' }} by {{ smeEmail }}</span>
      </div>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="recordNotFound" [@fadeIn]>
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h2>{{ errorTitle || 'Something went wrong' }}</h2>
      <p class="error-message">{{ errorMessage || 'We couldn\'t load the request details.' }}</p>
      <button class="refresh-btn" (click)="refreshPage()">
        <mat-icon>refresh</mat-icon> Try Again
      </button>
      <p class="support-message">
        If the problem persists, please contact support at
        <a href="mailto:datasupport@nist.gov">datasupport&#64;nist.gov</a>
      </p>
    </div>

    <!-- Main Content -->
    <div class="main-content" *ngIf="loaded && !recordNotFound">

      <!-- Requester Details - Full Width -->
      <div class="details-section">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Requester Information
        </h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="label">Name</span>
            <span class="value">{{ record?.userInfo.fullName }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Organization</span>
            <span class="value">{{ record?.userInfo.organization }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Email</span>
            <a [href]="'mailto:' + record?.userInfo.email" class="value email-link">
              {{ record?.userInfo.email }}
            </a>
          </div>
          <div class="detail-item">
            <span class="label">Country</span>
            <span class="value">{{ record?.userInfo.country }}</span>
          </div>
          <div class="detail-item" *ngIf="recordDescription?.phone">
            <span class="label">Phone</span>
            <span class="value">{{ recordDescription.phone }}</span>
          </div>
          <div class="detail-item" *ngIf="recordDescription?.address">
            <span class="label">Address</span>
            <span class="value">{{ recordDescription.address }}</span>
          </div>
        </div>
      </div>

      <!-- Product Card - Full Width -->
      <div class="product-card" *ngIf="recordDescription?.title">
        <mat-icon class="product-icon">dataset</mat-icon>
        <div class="product-info">
          <span class="product-label">Requested Product</span>
          <span class="product-title">{{ recordDescription.title }}</span>
        </div>
      </div>

      <!-- Action Notice & Buttons Row -->
      <div class="action-row">
        <div class="action-notice" [class.notice-pending]="status.toLowerCase().includes('pending')"
             [class.notice-approved]="status.toLowerCase().includes('approved')"
             [class.notice-declined]="status.toLowerCase().includes('declined')">
          <mat-icon>{{ status.toLowerCase().includes('pending') ? 'info' : 'warning' }}</mat-icon>
          <span *ngIf="status.toLowerCase().includes('pending')">
            Review and take action on this request.
          </span>
          <span *ngIf="status.toLowerCase().includes('approved')">
            Click <strong>Decline</strong> to revoke access.
          </span>
          <span *ngIf="status.toLowerCase().includes('declined')">
            Click <strong>Approve</strong> to grant access.
          </span>
        </div>

        <div class="action-buttons">
          <button mat-raised-button class="approve-btn"
                  *ngIf="status.toLowerCase().includes('pending') || status.toLowerCase().includes('declined')"
                  (click)="onApprove()"
                  [disabled]="displayProgressSpinner">
            <mat-icon>check_circle</mat-icon>
            Approve
          </button>
          <button mat-raised-button class="decline-btn"
                  *ngIf="status.toLowerCase().includes('pending') || status.toLowerCase().includes('approved')"
                  (click)="onDecline()"
                  [disabled]="displayProgressSpinner">
            <mat-icon>cancel</mat-icon>
            Decline
          </button>
        </div>
      </div>
    </div>
  </mat-card>
</div>

<!-- Dark Mode Toggle FAB -->
<button class="dark-mode-fab" (click)="toggleDarkMode()"
        [attr.aria-label]="isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'"
        matTooltip="{{ isDarkMode ? 'Light mode' : 'Dark mode' }}"
        matTooltipPosition="right">
  <mat-icon>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
</button>

<!-- Custom Toast Notification -->
<div class="toast-overlay" *ngIf="toastVisible" (click)="hideToast()">
  <div class="toast-container" [class.toast-success]="toastType === 'success'"
       [class.toast-error]="toastType === 'error'"
       [class.toast-info]="toastType === 'info'"
       (click)="$event.stopPropagation()">
    <div class="toast-icon">
      <mat-icon *ngIf="toastType === 'success'">check_circle</mat-icon>
      <mat-icon *ngIf="toastType === 'error'">error</mat-icon>
      <mat-icon *ngIf="toastType === 'info'">info</mat-icon>
    </div>
    <div class="toast-content">
      <h4 class="toast-title">
        {{ toastType === 'success' ? 'Success' : toastType === 'error' ? 'Error' : 'Info' }}
      </h4>
      <p class="toast-message">{{ toastMessage }}</p>
    </div>
    <button class="toast-close" (click)="hideToast()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<app-footer></app-footer>
