<app-header titleLn1="PDR" titleLn2="SME Approval"></app-header>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="displayProgressSpinner">
  <div class="spinner-container">
    <mat-spinner diameter="60" color="primary"></mat-spinner>
    <p class="loading-text">Processing request...</p>
  </div>
</div>

<div class="page-container">
  <mat-card class="approval-card" [@fadeInUp] *ngIf="loaded || recordNotFound">
    <!-- Status Header -->
    <div class="status-header" *ngIf="loaded"
         [class.status-pending]="status.toLowerCase().includes('pending')"
         [class.status-approved]="status.toLowerCase().includes('approved')"
         [class.status-declined]="status.toLowerCase().includes('declined')">
      <div class="status-icon">
        <mat-icon *ngIf="status.toLowerCase().includes('pending')">hourglass_empty</mat-icon>
        <mat-icon *ngIf="status.toLowerCase().includes('approved')">check_circle</mat-icon>
        <mat-icon *ngIf="status.toLowerCase().includes('declined')">cancel</mat-icon>
      </div>
      <h1 class="status-title">
        {{ status.toLowerCase().includes('pending') ? 'Pending Approval' :
           status.toLowerCase().includes('approved') ? 'Request Approved' :
           status.toLowerCase().includes('declined') ? 'Request Declined' : 'Unknown Status' }}
      </h1>
      <div class="case-number">
        <mat-icon>folder</mat-icon>
        <span>Case: {{ record?.caseNum }}</span>
      </div>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="recordNotFound" [@fadeIn]>
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h2>Something went wrong</h2>
      <p>We couldn't load the request details. Please try refreshing the page.</p>
      <button mat-raised-button color="primary" (click)="refreshPage()">
        <mat-icon>refresh</mat-icon>
        Refresh Page
      </button>
    </div>

    <!-- Main Content -->
    <mat-card-content *ngIf="loaded && !recordNotFound">
      <!-- Status Message for Approved/Declined -->
      <div class="status-message" *ngIf="!status.toLowerCase().includes('pending')" [@fadeIn]>
        <mat-icon>{{ status.toLowerCase().includes('approved') ? 'verified' : 'block' }}</mat-icon>
        <p>
          This request was <strong>{{ status.toLowerCase() }}</strong> on
          <strong>{{ statusDate | date:'longDate' }}</strong> by
          <strong>{{ smeEmail }}</strong>
        </p>
      </div>

      <!-- Request Details Section -->
      <div class="section-header">
        <mat-icon>description</mat-icon>
        <h2>Request Details</h2>
      </div>

      <div class="details-grid" [@fadeInUp]>
        <!-- Requester Information -->
        <div class="detail-card">
          <div class="detail-icon">
            <mat-icon>person</mat-icon>
          </div>
          <div class="detail-content">
            <span class="detail-label">Requester</span>
            <span class="detail-value">{{ record?.userInfo.fullName }}</span>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <mat-icon>business</mat-icon>
          </div>
          <div class="detail-content">
            <span class="detail-label">Organization</span>
            <span class="detail-value">{{ record?.userInfo.organization }}</span>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <mat-icon>email</mat-icon>
          </div>
          <div class="detail-content">
            <span class="detail-label">Email</span>
            <a class="detail-value email-link" [href]="'mailto:' + record?.userInfo.email">
              {{ record?.userInfo.email }}
            </a>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <mat-icon>public</mat-icon>
          </div>
          <div class="detail-content">
            <span class="detail-label">Country</span>
            <span class="detail-value">{{ record?.userInfo.country }}</span>
          </div>
        </div>

        <div class="detail-card" *ngIf="recordDescription?.phone">
          <div class="detail-icon">
            <mat-icon>phone</mat-icon>
          </div>
          <div class="detail-content">
            <span class="detail-label">Phone</span>
            <span class="detail-value">{{ recordDescription.phone }}</span>
          </div>
        </div>

        <div class="detail-card full-width" *ngIf="recordDescription?.address">
          <div class="detail-icon">
            <mat-icon>location_on</mat-icon>
          </div>
          <div class="detail-content">
            <span class="detail-label">Address</span>
            <span class="detail-value">{{ recordDescription.address }}</span>
          </div>
        </div>
      </div>

      <!-- Product Information -->
      <div class="section-header" *ngIf="recordDescription?.title">
        <mat-icon>inventory_2</mat-icon>
        <h2>Product Information</h2>
      </div>

      <div class="product-card" *ngIf="recordDescription?.title" [@fadeIn]>
        <mat-icon class="product-icon">dataset</mat-icon>
        <div class="product-details">
          <span class="product-label">Requested Product</span>
          <span class="product-title">{{ recordDescription.title }}</span>
        </div>
      </div>

      <!-- Action Notice -->
      <div class="action-notice" [@fadeIn]>
        <mat-icon>{{ status.toLowerCase().includes('pending') ? 'info' :
                     status.toLowerCase().includes('approved') ? 'warning' : 'info' }}</mat-icon>
        <p *ngIf="status.toLowerCase().includes('pending')">
          This request is still <strong>pending</strong>. Please approve or decline as soon as possible.
        </p>
        <p *ngIf="status.toLowerCase().includes('approved')">
          To revoke the requester's access to the data, click <strong>Decline</strong>.
        </p>
        <p *ngIf="status.toLowerCase().includes('declined')">
          To override this decline and grant access, click <strong>Approve</strong>.
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button mat-raised-button class="approve-btn"
                *ngIf="status.toLowerCase().includes('pending') || status.toLowerCase().includes('declined')"
                (click)="onApprove()"
                [disabled]="displayProgressSpinner">
          <mat-icon>check_circle</mat-icon>
          Approve
        </button>
        <button mat-raised-button class="decline-btn"
                *ngIf="status.toLowerCase().includes('pending') || status.toLowerCase().includes('approved')"
                (click)="onDecline()"
                [disabled]="displayProgressSpinner">
          <mat-icon>cancel</mat-icon>
          Decline
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Dark Mode Toggle FAB -->
<button class="dark-mode-fab" (click)="toggleDarkMode()"
        [attr.aria-label]="isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'"
        matTooltip="{{ isDarkMode ? 'Light mode' : 'Dark mode' }}"
        matTooltipPosition="right">
  <mat-icon>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
</button>

<app-footer></app-footer>
